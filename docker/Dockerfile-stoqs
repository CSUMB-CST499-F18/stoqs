FROM pcic/geospatial-python
MAINTAINER Mike McCann <mccann@mbari.org>

# Modeled after http://michal.karzynski.pl/blog/2015/04/19/packaging-django-applications-as-docker-container-images/

ENV STOQS_SRVHOME=/srv
ENV STOQS_SRVPROJ=/srv/stoqs

RUN apt-get update && \
    apt-get -qq -y install \
    freetds-dev \
    git \
    ##gmt \
    ##gmt-dcw \
    ##gmt-gshhg \
    libncurses-dev \
    postgresql-9.6 \
    wget


# Make sure python and python-config refer to corresponding Python 3 versions
RUN cd /usr/bin/ &&\
    ln -fs python3 python &&\
    ln -fs python3-config python-config

# Create application subdirectories
WORKDIR $STOQS_SRVHOME
RUN mkdir media static logs
VOLUME ["$STOQS_SRVHOME/media/", "$STOQS_SRVHOME/logs/"]


COPY requirements $STOQS_SRVPROJ/requirements/
RUN /bin/bash -c '\
    pip3 install -r $STOQS_SRVPROJ/requirements/production.txt'

RUN echo "alias psql='psql --host=stoqs-postgis --port=5432'" >> /root/.bashrc

COPY stoqs $STOQS_SRVPROJ
COPY test.sh $STOQS_SRVHOME
COPY docker/stoqs-entrypoint.sh /

ENTRYPOINT ["/stoqs-entrypoint.sh"]
